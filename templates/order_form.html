{% extends "base.html" %}
{% block title %}Sipari≈ü Formu{% endblock %}

{% block extra_head %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  // ----- Tabs (main categories) -----
  const tabButtons = document.querySelectorAll("[data-tab-target]");
  const tabPanels  = document.querySelectorAll("[data-tab-panel]");

  function activateTab(targetId) {
    tabButtons.forEach(btn => {
      btn.classList.toggle("active", btn.dataset.tabTarget === targetId);
    });
    tabPanels.forEach(panel => {
      panel.classList.toggle("active", panel.dataset.tabPanel === targetId);
    });
  }

  if (tabButtons.length > 0) {
    // Default: open the first tab
    activateTab(tabButtons[0].dataset.tabTarget);
  }

  tabButtons.forEach(btn => {
    btn.addEventListener("click", function () {
      activateTab(this.dataset.tabTarget);
    });
  });
  // ----- SessionStorage helpers for cart (persists only for this tab/session) -----
  const STORAGE_KEY = "order_cart_v1";
  const STORAGE = window.sessionStorage;

  function loadCart() {
    try {
      const raw = STORAGE.getItem(STORAGE_KEY);
      if (!raw) return {};
      const parsed = JSON.parse(raw);
      return parsed && typeof parsed === "object" ? parsed : {};
    } catch (e) {
      console.warn("Could not parse cart from sessionStorage:", e);
      return {};
    }
  }

  function saveCart() {
    const cart = {};
    document.querySelectorAll(".qty-control").forEach(function (wrapper) {
      const pid = wrapper.dataset.productId;
      const input = wrapper.querySelector(".qty-input");
      if (!pid || !input) return;

      const val = parseInt(input.value || "0", 10);
      if (!Number.isNaN(val) && val > 0) {
        cart[pid] = val;
      }
    });
    try {
      STORAGE.setItem(STORAGE_KEY, JSON.stringify(cart));
    } catch (e) {
      console.warn("Could not save cart to sessionStorage:", e);
    }
  }

  // Apply saved cart on page load
  const savedCart = loadCart();
  document.querySelectorAll(".qty-control").forEach(function (wrapper) {
    const pid = wrapper.dataset.productId;
    const input = wrapper.querySelector(".qty-input");
    if (!pid || !input) return;

    if (savedCart[pid] != null) {
      input.value = savedCart[pid];
    }
  });
  // Listen to manual input changes
  document.querySelectorAll(".qty-input").forEach(function (input) {
    input.addEventListener("change", function() {
      saveCart();
      updateCartBadge();
    });
  });

  // ----- Quantity +/- with press-and-hold (using pointer events) -----
  function changeQty(input, delta) {
    const min = parseInt(input.getAttribute("min") || "0", 10);
    let value = parseInt(input.value || "0", 10);
    if (Number.isNaN(value)) value = 0;

    value += delta;
    if (value < min) value = min;
    input.value = value;
    saveCart();
    updateCartBadge();
  }

  document.querySelectorAll(".qty-btn").forEach(function (btn) {
    let intervalId = null;
    let holdTimeoutId = null;
    const delta = btn.dataset.qtyBtn === "plus" ? 1 : -1;

    function stepOnce() {
      const wrapper = btn.closest(".qty-control");
      if (!wrapper) return;
      const input = wrapper.querySelector(".qty-input");
      if (!input) return;
      changeQty(input, delta);
      updateCartBadge()
    }

    function start(e) {
      e.preventDefault(); // avoid selection / double-tap zoom

      // For mouse: only left button
      if (e.pointerType === "mouse" && e.button !== 0) return;

      // Single immediate step for click
      stepOnce();

      // Start repeat only if user keeps holding for a while (e.g. 400 ms)
      holdTimeoutId = setTimeout(function () {
        intervalId = setInterval(stepOnce, 120); // repeat while held
      }, 400);
    }

    function stop() {
      if (holdTimeoutId) {
        clearTimeout(holdTimeoutId);
        holdTimeoutId = null;
      }
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }
    }

    // Pointer events cover mouse, touch, pen
    btn.addEventListener("pointerdown", start);
    btn.addEventListener("pointerup", stop);
    btn.addEventListener("pointerleave", stop);
    btn.addEventListener("pointercancel", stop);
  });

  // ----- Auto-select input value on focus + save cart on change -----
  document.querySelectorAll(".qty-input").forEach(function (input) {
    input.addEventListener("focus", function () {
      this.select();
    });
    input.addEventListener("click", function () {
      this.select();
    });
    input.addEventListener("change", saveCart);
    input.addEventListener("blur", saveCart);
  });

  // ----- Accordion behavior for subcategory <details> -----
    // ----- Accordion behavior for subcategory <details> + scroll to top -----
  const allDetails = document.querySelectorAll(".subcategory-details");

  function scrollDetailsToTop(el) {
    // Scroll so that the <details> starts just below the header
    const headerOffset = 80; // adjust if your header is taller/shorter
    const rect = el.getBoundingClientRect();
    const offsetTop = rect.top + window.pageYOffset - headerOffset;

    window.scrollTo({
      top: offsetTop,
      behavior: "smooth",
    });
  }

  allDetails.forEach(function (det) {
    det.addEventListener("toggle", function () {
      if (this.open) {
        // Close all others
        allDetails.forEach(function (other) {
          if (other !== det) {
            other.open = false;
          }
        });

        // Scroll this one to the top (slight delay so layout can settle)
        setTimeout(function () {
          scrollDetailsToTop(det);
        }, 50);
      }
    });
  });


  // ----- Product search (scroll to matching product) -----
  const searchInput = document.getElementById("product-search-input");
  const searchBtn = document.getElementById("product-search-btn");

  function normalize(str) {
    return str ? str.toString().toLowerCase().trim() : "";
  }

  function clearHighlights() {
    document.querySelectorAll(".product-highlight").forEach(function (el) {
      el.classList.remove("product-highlight");
    });
  }

  function openParentSections(card) {
    // Open the correct tab
    const tabPanel = card.closest("[data-tab-panel]");
    if (tabPanel) {
      const targetId = tabPanel.dataset.tabPanel;
      activateTab(targetId);
    }
    // Open the correct subcategory <details>
    const details = card.closest("details");
    if (details && !details.open) {
      details.open = true;
    }
  }

  function searchAndScroll() {
    const q = normalize(searchInput.value);
    if (!q) return;

    clearHighlights();

    const cards = document.querySelectorAll(".card[data-product-name]");
    let match = null;

    cards.forEach(function (card) {
      if (match) return;
      const name = normalize(card.dataset.productName);
      const code = normalize(card.dataset.productCode);
      if ((name && name.includes(q)) || (code && code.includes(q))) {
        match = card;
      }
    });

    if (match) {
      openParentSections(match);
      match.classList.add("product-highlight");
      match.scrollIntoView({ behavior: "smooth", block: "center" });
    } else {
      // Optional: small visual feedback; for now we do nothing
      // alert("√úr√ºn bulunamadƒ±");
    }
  }

  if (searchInput && searchBtn) {
    searchBtn.addEventListener("click", function (e) {
      e.preventDefault();
      searchAndScroll();
    });
    searchInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        searchAndScroll();
      }
    });
  }

  // ----- Sticky submit button triggers form submit -----
  // const stickyBtn = document.getElementById("sticky-submit-btn");
  // if (stickyBtn) {
  //   stickyBtn.addEventListener("click", function () {
  //     const form = document.querySelector(".page-wrapper form");
  //     if (form) form.submit();
  //   });
  // }
  // ----- Discount celebration tracking -----
  let currentTier = null;
  let lastShownNextTier = null;

  function createConfetti() {
    const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
    const confettiCount = 50;
    
    for (let i = 0; i < confettiCount; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + '%';
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.animationDelay = Math.random() * 0.5 + 's';
      document.body.appendChild(confetti);
      
      setTimeout(() => confetti.remove(), 3000);
    }
  }

  function showCelebration(discount) {
    createConfetti();
    
    const popup = document.createElement('div');
    popup.className = 'discount-popup';
    popup.innerHTML = `
      <div class="popup-content">
        <div class="popup-icon">üéâ</div>
        <h3>Tebrikler!</h3>
        <p>%${discount} ƒ∞ndirim Kazandƒ±nƒ±z!</p>
      </div>
    `;
    document.body.appendChild(popup);
    
    setTimeout(() => popup.classList.add('show'), 100);
    setTimeout(() => {
      popup.classList.remove('show');
      setTimeout(() => popup.remove(), 300);
    }, 3000);
  }

  function showNextTierMessage(nextThreshold, nextDiscount, remaining) {
    const popup = document.createElement('div');
    popup.className = 'next-tier-popup';
    popup.innerHTML = `
      <div class="popup-content">
        <div class="popup-icon">üí∞</div>
        <p>${remaining.toFixed(2)} TL daha ekleyin,<br>%${nextDiscount} indirim kazanƒ±n!</p>
      </div>
    `;
    document.body.appendChild(popup);
    
    setTimeout(() => popup.classList.add('show'), 100);
    setTimeout(() => {
      popup.classList.remove('show');
      setTimeout(() => popup.remove(), 300);
    }, 4000);
  }

  // ----- Discount tiers -----
  const discountTiers = JSON.parse('{{ discount_tiers|escapejs }}') || [];
  console.log("DEBUG: discountTiers =", discountTiers);
  console.log("DEBUG: type =", typeof discountTiers);
  // ----- Update floating cart badge -----
  function updateCartBadge() {
    const cart = loadCart();
    let totalItems = 0;
    let subtotal = 0;
    
    for (const pid in cart) {
      const qty = cart[pid];
      totalItems += qty;
      
      const productCard = document.querySelector(`[data-product-id="${pid}"]`);
      if (productCard) {
        const priceText = productCard.dataset.productPrice;
        if (priceText) {
          const price = parseFloat(priceText);
          subtotal += price * qty;
        }
      }
    }
    
    // Find applicable discount
    let discount = 0;
    let appliedTierIndex = -1;
    for (let i = discountTiers.length - 1; i >= 0; i--) {
      if (subtotal >= parseFloat(discountTiers[i].threshold)) {
        discount = parseFloat(discountTiers[i].discount_percentage);
        appliedTierIndex = i;
        break;
      }
    }
    
    // Check if discount tier just unlocked
    if (discount > 0 && currentTier !== discount) {
      if (currentTier !== null) { // Don't show on first load
        showCelebration(discount);
      }
      currentTier = discount;
      lastShownNextTier = null; // Reset next tier message
    } else if (discount === 0) {
      currentTier = null;
    }
    
    // Find next tier and show message
    if (subtotal > 0) {
      let nextTier = null;
      if (appliedTierIndex >= 0 && appliedTierIndex < discountTiers.length - 1) {
        nextTier = discountTiers[appliedTierIndex + 1];
      } else if (appliedTierIndex === -1 && discountTiers.length > 0) {
        nextTier = discountTiers[0];
      }
      
      if (nextTier) {
        const nextThreshold = parseFloat(nextTier.threshold);
        if (lastShownNextTier !== nextThreshold) {
          const remaining = nextThreshold - subtotal;
          showNextTierMessage(nextThreshold, nextTier.discount_percentage, remaining);
          lastShownNextTier = nextThreshold;
        }
      }
    }
    
    const discountAmount = subtotal * (discount / 100);
    const finalTotal = subtotal - discountAmount;
    
    // Update badge with discount
    const badge = document.getElementById('floatingCart');
    
    if (discount > 0) {
      badge.innerHTML = `
        <div class="cart-icon">üõí</div>
        <div class="cart-details">
          <span class="cart-count">${totalItems}</span> √ºr√ºn
          <div class="cart-subtotal">
            <span class="cart-original">${subtotal.toFixed(2)} ‚Ç∫</span>
          </div>
          <div class="cart-discount">-%${discount} ƒ∞ndirim</div>
          <div class="cart-total">${finalTotal.toFixed(2)} ‚Ç∫</div>
        </div>
      `;
    } else {
      badge.innerHTML = `
        <div class="cart-icon">üõí</div>
        <div class="cart-details">
          <span class="cart-count">${totalItems}</span> √ºr√ºn
          <div class="cart-total">${finalTotal.toFixed(2)} ‚Ç∫</div>
        </div>
      `;
    }
    
    if (totalItems === 0) {
      badge.style.display = 'none';
    } else {
      badge.style.display = 'flex';
    }
  }
  
  // Call on page load to restore cart state
  updateCartBadge();
  // ----- Quantity Preset Buttons -----
document.querySelectorAll('.qty-preset').forEach(function(btn) {
  btn.addEventListener('click', function(e) {
    e.preventDefault();
    
    const qty = parseInt(this.dataset.qty);
    const control = this.closest('.qty-control');
    const input = control.querySelector('.qty-input');
    
    if (input) {
      input.value = qty;
      saveCart();
      updateCartBadge();
      
      // Visual feedback
      this.style.background = '#27ae60';
      this.style.color = 'white';
      setTimeout(() => {
        this.style.background = '';
        this.style.color = '';
      }, 200);
    }
  });
  });
  // ----- Empty Cart Warning -----
const orderForm = document.querySelector('.page-wrapper form');
if (orderForm) {
  orderForm.addEventListener('submit', function(e) {
    const cart = loadCart();
    
    // Count total items
    let totalItems = 0;
    for (const pid in cart) {
      totalItems += cart[pid];
    }
    
    if (totalItems === 0) {
      e.preventDefault(); // Stop form submission
      
      // Show warning
      alert('‚ö†Ô∏è Sepetiniz bo≈ü!\n\nL√ºtfen en az bir √ºr√ºn se√ßiniz.');
      
      // Scroll to products section
      document.querySelector('.section-card').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
      });
    }
  });
}
});
</script>
{% endblock %}

{% block content %}
<div class="page-wrapper">

  <!-- Floating Cart Badge-->
   <div class="floating-cart" id="floatingCart">
    <div class="cart-icon">üõí</div>
    <div class="cart-details">
      <span class="cart-count" id="cartCount">0</span> √ºr√ºn
      <div class="cart-total" id="cartTotal">0.00 ‚Ç∫</div>
    </div>
  </div>
  <!-- Progress Bar -->
  <div class="progress-bar">
    <div class="progress-step completed">
      <div class="step-number">1</div>
      <div class="step-label">Bilgiler</div>
    </div>
    <div class="progress-step active">
      <div class="step-number">2</div>
      <div class="step-label">√úr√ºnler</div>
    </div>
    <div class="progress-step">
      <div class="step-number">3</div>
      <div class="step-label">Onay</div>
    </div>
  </div>

  <!-- Customer Info Display (NEW!) -->
  <div class="customer-info-display">
    <h3>üë§ Merhaba, {{ customer_name }}!</h3>
    <div class="customer-details">
      <div class="detail-item">
        <span class="detail-label">Telefon</span>
        <span class="detail-value">üìû {{ customer_phone }}</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">E-posta</span>
        <span class="detail-value">‚úâÔ∏è {{ customer_email|default:"Belirtilmemi≈ü" }}</span>
      </div>
    </div>
    <a href="{% url 'customer_info' customer_type=customer_type %}" class="edit-info-btn">
      ‚úèÔ∏è Bilgileri D√ºzenle
    </a>
  </div>
  
  {# ----- Error messages ----- #}
  {% if error_list %}
    <div class="section-card error-box">
      <ul class="error-list">
        {% for e in error_list %}
          <li>{{ e }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="POST">
    {% csrf_token %}

    <!-- {# ----- Customer information ----- #}
    <section class="section-card section-customer">
      <div class="section-header">
        <h2 class="section-title">M√º≈üteri bilgileri</h2>
        <p class="section-subtitle">L√ºtfen ileti≈üim bilgilerinizi doldurunuz.</p>
      </div>

      <div class="form-grid">
        <div>
          <label>ƒ∞sim<span class="required-star">*</span>:</label><br>
          <input type="text" name="customer_name" required
                 value="{{ customer_name|default_if_none:'' }}"
                 style="width: 100%; max-width: 300px;">
        </div>

        <div>
          <label>Telefon<span class="required-star">*</span>:</label><br>
          <input type="text" name="customer_phone" required
                 value="{{ customer_phone|default_if_none:'' }}"
                 style="width: 100%; max-width: 300px;">
        </div>

        <div>
          <label>E-posta<span class="required-star">*</span>:</label><br>
          <input type="email" name="customer_email" required
                 value="{{ customer_email|default_if_none:'' }}"
                 style="width: 100%; max-width: 300px;">
        </div>
      </div>

      <div style="margin-top: 12px;">
        <label>Notlar:</label><br>
        <textarea name="customer_note" rows="3"
                  style="width: 100%; max-width: 600px;">{{ customer_note|default_if_none:'' }}</textarea>
      </div>
    </section> -->

    {# ----- Products ----- #}
    <section class="section-card">
      <div class="section-header">
        <h2 class="section-title">√úr√ºnler</h2>
        <p class="section-subtitle">Sipari≈ü etmek istediƒüiniz √ºr√ºnleri se√ßiniz.</p>
      </div>

      {# Product search bar #}
      <div class="product-search-bar">
        <input type="text"
               id="product-search-input"
               class="product-search-input"
               placeholder="√úr√ºn adƒ± veya kodu ile ara...">
        <button type="button"
                class="primary-btn secondary-btn"
                id="product-search-btn">
          Ara
        </button>
      </div>

      {% if main_categories %}
        {# Tabs for main categories #}
        <div class="tabs">
          {% for main in main_categories %}
            <button type="button"
                    class="tab-button"
                    data-tab-target="cat-{{ main.id }}">
              {{ main.name }}
            </button>
          {% endfor %}
        </div>

        {# Panels for each main category #}
        {% for main in main_categories %}
          <section class="tab-panel" data-tab-panel="cat-{{ main.id }}">

            {% if main.subcategories.all %}
              {% for sub in main.subcategories.all %}
                {# details: now CLOSED by default (no "open" attribute) #}
                <details class="subcategory-details" style="margin-bottom: 16px; border-left: 5px solid {{ sub.color_code|default:'#CCCCCC' }};">
                  <summary style="background: linear-gradient(to right, {{ sub.color_code|default:'#CCCCCC' }}40, transparent);">
                    {{ sub.name }}
                  </summary>

                  <div class="grid" style="margin-top: 8px;">
                    {% for p in sub.products.all %}
                      {% if p.is_active %}
                        <div class="card"
     data-product-id="{{ p.id }}"
     data-product-name="{{ p.name }}"
     data-product-code="{{ p.code }}"
     data-product-price="{{ p.final_price|default:0 }}">
  <div class="imgbox">
    {% if p.image %}
      <img src="{{ p.image.url }}" alt="{{ p.name }}" loading="lazy">
    {% else %}
      <div class="muted">G√∂rsel yok</div>
    {% endif %}
  </div>

  <div class="name">{{ p.name }}</div>

  <div class="muted">
    {% if p.code %}Kod: {{ p.code }}<br>{% endif %}
  </div>

  <div class="card-footer-line">
    <div class="card-price">
      {% if p.price %}
        {% if p.discount_price or p.discount_percent %}
          <div class="discount-badge">
            ƒ∞ndirim -{% if p.discount_percent %}{{ p.discount_percent }}%{% else %}√∂zel fiyat{% endif %}
          </div>
          <div class="price-row">
            <span class="price-new">
              {{ p.final_price }} ‚Ç∫{% if p.unit %} / {{ p.unit }}{% endif %}
            </span>
            <span class="price-old">{{ p.price }} ‚Ç∫</span>
          </div>
        {% else %}
          <div class="price-row">
            <span class="price-normal">
              {{ p.price }} ‚Ç∫{% if p.unit %} / {{ p.unit }}{% endif %}
            </span>
          </div>
        {% endif %}
      {% endif %}
    </div>

    <div class="card-qty">
      <div class="qty-control" data-product-id="{{ p.id }}">
        <button type="button" class="qty-btn" data-qty-btn="minus">‚àí</button>
        <input type="number"
               class="qty-input"
               name="qty_{{ p.id }}"
               min="0"
               value="0"
               inputmode="numeric"
               pattern="[0-9]*">
        <button type="button" class="qty-btn" data-qty-btn="plus">+</button>
      <div class="qty-presets">
        <button type="button" class="qty-preset" data-qty="1">1</button>
        <button type="button" class="qty-preset" data-qty="3">3</button>
        <button type="button" class="qty-preset" data-qty="6">6</button>
        <button type="button" class="qty-preset" data-qty="12">12</button>
      </div>
      </div>
    </div>
  </div>
</div>

                      {% endif %}
                    {% empty %}
                      <p class="muted">Bu alt kategoride hen√ºz √ºr√ºn yok.</p>
                    {% endfor %}
                  </div>
                </details>
              {% endfor %}
            {% else %}
              <p class="muted">Bu ana kategoriye ait alt kategori tanƒ±mlanmamƒ±≈ü.</p>

              <div class="grid" style="margin-top: 8px;">
                {% for p in main.products.all %}
                  {% if p.is_active %}
                    <div class="card"
     data-product-id="{{ p.id }}"
     data-product-name="{{ p.name }}"
     data-product-code="{{ p.code }}"
     data-product-price="{{ p.final_price|default:0 }}">
  <div class="imgbox">
    {% if p.image %}
      <img src="{{ p.image.url }}" alt="{{ p.name }}" loading="lazy">
    {% else %}
      <div class="muted">G√∂rsel yok</div>
    {% endif %}
  </div>

  <div class="name">{{ p.name }}</div>

  <div class="muted">
    {% if p.code %}Kod: {{ p.code }}<br>{% endif %}
  </div>

  <div class="card-footer-line">
    <div class="card-price">
      {% if p.price %}
        {% if p.discount_price or p.discount_percent %}
          <div class="discount-badge">
            ƒ∞ndirim -{% if p.discount_percent %}{{ p.discount_percent }}%{% else %}√∂zel fiyat{% endif %}
          </div>
          <div class="price-row">
            <span class="price-new">
              {{ p.final_price }} ‚Ç∫{% if p.unit %} / {{ p.unit }}{% endif %}
            </span>
            <span class="price-old">{{ p.price }} ‚Ç∫</span>
          </div>
        {% else %}
          <div class="price-row">
            <span class="price-normal">
              {{ p.price }} ‚Ç∫{% if p.unit %} / {{ p.unit }}{% endif %}
            </span>
          </div>
        {% endif %}
      {% endif %}
    </div>

    <div class="card-qty">
      <div class="qty-control" data-product-id="{{ p.id }}">
        <button type="button" class="qty-btn" data-qty-btn="minus">‚àí</button>
        <input type="number"
               class="qty-input"
               name="qty_{{ p.id }}"
               min="0"
               value="0"
               inputmode="numeric"
               pattern="[0-9]*">
               
        <button type="button" class="qty-btn" data-qty-btn="plus">+</button>
        <div class="qty-presets">
          <button type="button" class="qty-preset" data-qty="1">1</button>
          <button type="button" class="qty-preset" data-qty="3">3</button>
          <button type="button" class="qty-preset" data-qty="6">6</button>
          <button type="button" class="qty-preset" data-qty="12">12</button>
        </div>
      </div>
    </div>
  </div>
</div>

                  {% endif %}
                {% empty %}
                  <p class="muted">Bu kategoride hen√ºz √ºr√ºn yok.</p>
                {% endfor %}
              </div>
            {% endif %}
          </section>
        {% endfor %}
      {% else %}
        <p class="muted">
          Hen√ºz kategori bulunmamaktadƒ±r. L√ºtfen y√∂netim panelinden kategori ve √ºr√ºn ekleyiniz.
        </p>
      {% endif %}
    </section>

    {# ----- Static submit button at bottom (for desktop) ----- #}
    <div class="form-actions">
      <button type="submit" class="primary-btn">
        Devam Et
      </button>
    </div>
  </form>

  {# ----- Sticky submit button (always visible) ----- #}
  <!-- <div class="sticky-submit-bar">
    <div class="sticky-submit-inner">
      <button type="button" class="primary-btn" id="sticky-submit-btn">
        Sipari≈üi G√∂nder
      </button>
    </div>
  </div> -->
</div>
{% endblock %}
