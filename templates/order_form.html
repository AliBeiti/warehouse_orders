{% extends "base.html" %}
{% block title %}Sipariş Formu{% endblock %}

{% block extra_head %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  // ----- Tabs (main categories) -----
  const tabButtons = document.querySelectorAll("[data-tab-target]");
  const tabPanels  = document.querySelectorAll("[data-tab-panel]");

  function activateTab(targetId) {
    tabButtons.forEach(btn => {
      btn.classList.toggle("active", btn.dataset.tabTarget === targetId);
    });
    tabPanels.forEach(panel => {
      panel.classList.toggle("active", panel.dataset.tabPanel === targetId);
    });
  }

  if (tabButtons.length > 0) {
    // Default: open the first tab
    activateTab(tabButtons[0].dataset.tabTarget);
  }

  tabButtons.forEach(btn => {
    btn.addEventListener("click", function () {
      activateTab(this.dataset.tabTarget);
    });
  });

  // ----- LocalStorage helpers for cart -----
  const STORAGE_KEY = "order_cart_v1";

  function loadCart() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return {};
      const parsed = JSON.parse(raw);
      return parsed && typeof parsed === "object" ? parsed : {};
    } catch (e) {
      console.warn("Could not parse cart from localStorage:", e);
      return {};
    }
  }

  function saveCart() {
    const cart = {};
    document.querySelectorAll(".qty-control").forEach(function (wrapper) {
      const pid = wrapper.dataset.productId;
      const input = wrapper.querySelector(".qty-input");
      if (!pid || !input) return;

      const val = parseInt(input.value || "0", 10);
      if (!Number.isNaN(val) && val > 0) {
        cart[pid] = val;
      }
    });
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cart));
    } catch (e) {
      console.warn("Could not save cart to localStorage:", e);
    }
  }

  // Apply saved cart on page load
  const savedCart = loadCart();
  document.querySelectorAll(".qty-control").forEach(function (wrapper) {
    const pid = wrapper.dataset.productId;
    const input = wrapper.querySelector(".qty-input");
    if (!pid || !input) return;

    if (savedCart[pid] != null) {
      input.value = savedCart[pid];
    }
  });

  // ----- Quantity +/- with press-and-hold (using pointer events) -----
  function changeQty(input, delta) {
    const min = parseInt(input.getAttribute("min") || "0", 10);
    let value = parseInt(input.value || "0", 10);
    if (Number.isNaN(value)) value = 0;

    value += delta;
    if (value < min) value = min;
    input.value = value;
    saveCart();
  }

  document.querySelectorAll(".qty-btn").forEach(function (btn) {
    let intervalId = null;
    let holdTimeoutId = null;
    const delta = btn.dataset.qtyBtn === "plus" ? 1 : -1;

    function stepOnce() {
      const wrapper = btn.closest(".qty-control");
      if (!wrapper) return;
      const input = wrapper.querySelector(".qty-input");
      if (!input) return;
      changeQty(input, delta);
    }

    function start(e) {
      e.preventDefault(); // avoid selection / double-tap zoom

      // For mouse: only left button
      if (e.pointerType === "mouse" && e.button !== 0) return;

      // Single immediate step for click
      stepOnce();

      // Start repeat only if user keeps holding for a while (e.g. 400 ms)
      holdTimeoutId = setTimeout(function () {
        intervalId = setInterval(stepOnce, 120); // repeat while held
      }, 400);
    }

    function stop() {
      if (holdTimeoutId) {
        clearTimeout(holdTimeoutId);
        holdTimeoutId = null;
      }
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }
    }

    // Pointer events cover mouse, touch, pen
    btn.addEventListener("pointerdown", start);
    btn.addEventListener("pointerup", stop);
    btn.addEventListener("pointerleave", stop);
    btn.addEventListener("pointercancel", stop);
  });

  // ----- Auto-select input value on focus + save cart on change -----
  document.querySelectorAll(".qty-input").forEach(function (input) {
    input.addEventListener("focus", function () {
      this.select();
    });
    input.addEventListener("click", function () {
      this.select();
    });
    input.addEventListener("change", saveCart);
    input.addEventListener("blur", saveCart);
  });

  // ----- Accordion behavior for subcategory <details> -----
    // ----- Accordion behavior for subcategory <details> + scroll to top -----
  const allDetails = document.querySelectorAll(".subcategory-details");

  function scrollDetailsToTop(el) {
    // Scroll so that the <details> starts just below the header
    const headerOffset = 80; // adjust if your header is taller/shorter
    const rect = el.getBoundingClientRect();
    const offsetTop = rect.top + window.pageYOffset - headerOffset;

    window.scrollTo({
      top: offsetTop,
      behavior: "smooth",
    });
  }

  allDetails.forEach(function (det) {
    det.addEventListener("toggle", function () {
      if (this.open) {
        // Close all others
        allDetails.forEach(function (other) {
          if (other !== det) {
            other.open = false;
          }
        });

        // Scroll this one to the top (slight delay so layout can settle)
        setTimeout(function () {
          scrollDetailsToTop(det);
        }, 50);
      }
    });
  });


  // ----- Product search (scroll to matching product) -----
  const searchInput = document.getElementById("product-search-input");
  const searchBtn = document.getElementById("product-search-btn");

  function normalize(str) {
    return str ? str.toString().toLowerCase().trim() : "";
  }

  function clearHighlights() {
    document.querySelectorAll(".product-highlight").forEach(function (el) {
      el.classList.remove("product-highlight");
    });
  }

  function openParentSections(card) {
    // Open the correct tab
    const tabPanel = card.closest("[data-tab-panel]");
    if (tabPanel) {
      const targetId = tabPanel.dataset.tabPanel;
      activateTab(targetId);
    }
    // Open the correct subcategory <details>
    const details = card.closest("details");
    if (details && !details.open) {
      details.open = true;
    }
  }

  function searchAndScroll() {
    const q = normalize(searchInput.value);
    if (!q) return;

    clearHighlights();

    const cards = document.querySelectorAll(".card[data-product-name]");
    let match = null;

    cards.forEach(function (card) {
      if (match) return;
      const name = normalize(card.dataset.productName);
      const code = normalize(card.dataset.productCode);
      if ((name && name.includes(q)) || (code && code.includes(q))) {
        match = card;
      }
    });

    if (match) {
      openParentSections(match);
      match.classList.add("product-highlight");
      match.scrollIntoView({ behavior: "smooth", block: "center" });
    } else {
      // Optional: small visual feedback; for now we do nothing
      // alert("Ürün bulunamadı");
    }
  }

  if (searchInput && searchBtn) {
    searchBtn.addEventListener("click", function (e) {
      e.preventDefault();
      searchAndScroll();
    });
    searchInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        searchAndScroll();
      }
    });
  }

  // ----- Sticky submit button triggers form submit -----
  const stickyBtn = document.getElementById("sticky-submit-btn");
  if (stickyBtn) {
    stickyBtn.addEventListener("click", function () {
      const form = document.querySelector(".page-wrapper form");
      if (form) form.submit();
    });
  }
});
</script>
{% endblock %}

{% block content %}
<div class="page-wrapper">

  {# ----- Error messages ----- #}
  {% if error_list %}
    <div class="section-card error-box">
      <ul class="error-list">
        {% for e in error_list %}
          <li>{{ e }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="POST">
    {% csrf_token %}

    {# ----- Customer information ----- #}
    <section class="section-card section-customer">
      <div class="section-header">
        <h2 class="section-title">Müşteri bilgileri</h2>
        <p class="section-subtitle">Lütfen iletişim bilgilerinizi doldurunuz.</p>
      </div>

      <div class="form-grid">
        <div>
          <label>İsim<span class="required-star">*</span>:</label><br>
          <input type="text" name="customer_name" required
                 value="{{ customer_name|default_if_none:'' }}"
                 style="width: 100%; max-width: 300px;">
        </div>

        <div>
          <label>Telefon<span class="required-star">*</span>:</label><br>
          <input type="text" name="customer_phone" required
                 value="{{ customer_phone|default_if_none:'' }}"
                 style="width: 100%; max-width: 300px;">
        </div>

        <div>
          <label>E-posta<span class="required-star">*</span>:</label><br>
          <input type="email" name="customer_email" required
                 value="{{ customer_email|default_if_none:'' }}"
                 style="width: 100%; max-width: 300px;">
        </div>
      </div>

      <div style="margin-top: 12px;">
        <label>Notlar:</label><br>
        <textarea name="customer_note" rows="3"
                  style="width: 100%; max-width: 600px;">{{ customer_note|default_if_none:'' }}</textarea>
      </div>
    </section>

    {# ----- Products ----- #}
    <section class="section-card">
      <div class="section-header">
        <h2 class="section-title">Ürünler</h2>
        <p class="section-subtitle">Sipariş etmek istediğiniz ürünleri seçiniz.</p>
      </div>

      {# Product search bar #}
      <div class="product-search-bar">
        <input type="text"
               id="product-search-input"
               class="product-search-input"
               placeholder="Ürün adı veya kodu ile ara...">
        <button type="button"
                class="primary-btn secondary-btn"
                id="product-search-btn">
          Ara
        </button>
      </div>

      {% if main_categories %}
        {# Tabs for main categories #}
        <div class="tabs">
          {% for main in main_categories %}
            <button type="button"
                    class="tab-button"
                    data-tab-target="cat-{{ main.id }}">
              {{ main.name }}
            </button>
          {% endfor %}
        </div>

        {# Panels for each main category #}
        {% for main in main_categories %}
          <section class="tab-panel" data-tab-panel="cat-{{ main.id }}">

            {% if main.subcategories.all %}
              {% for sub in main.subcategories.all %}
                {# details: now CLOSED by default (no "open" attribute) #}
                <details class="subcategory-details" style="margin-bottom: 16px;">
                  <summary>
                    {{ sub.name }}
                  </summary>

                  <div class="grid" style="margin-top: 8px;">
                    {% for p in sub.products.all %}
                      {% if p.is_active %}
                        <div class="card"
     data-product-id="{{ p.id }}"
     data-product-name="{{ p.name }}"
     data-product-code="{{ p.code }}">
  <div class="imgbox">
    {% if p.image %}
      <img src="{{ p.image.url }}" alt="{{ p.name }}" loading="lazy">
    {% else %}
      <div class="muted">Görsel yok</div>
    {% endif %}
  </div>

  <div class="name">{{ p.name }}</div>

  <div class="muted">
    {% if p.code %}Kod: {{ p.code }}<br>{% endif %}
  </div>

  <div class="card-footer-line">
    <div class="card-price">
      {% if p.price %}
        {% if p.discount_price or p.discount_percent %}
          <div class="discount-badge">
            İndirim -{% if p.discount_percent %}{{ p.discount_percent }}%{% else %}özel fiyat{% endif %}
          </div>
          <div class="price-row">
            <span class="price-new">
              {{ p.final_price }} ₺{% if p.unit %} / {{ p.unit }}{% endif %}
            </span>
            <span class="price-old">{{ p.price }} ₺</span>
          </div>
        {% else %}
          <div class="price-row">
            <span class="price-normal">
              {{ p.price }} ₺{% if p.unit %} / {{ p.unit }}{% endif %}
            </span>
          </div>
        {% endif %}
      {% endif %}
    </div>

    <div class="card-qty">
      <div class="qty-control" data-product-id="{{ p.id }}">
        <button type="button" class="qty-btn" data-qty-btn="minus">−</button>
        <input type="number"
               class="qty-input"
               name="qty_{{ p.id }}"
               min="0"
               value="0">
        <button type="button" class="qty-btn" data-qty-btn="plus">+</button>
      </div>
    </div>
  </div>
</div>

                      {% endif %}
                    {% empty %}
                      <p class="muted">Bu alt kategoride henüz ürün yok.</p>
                    {% endfor %}
                  </div>
                </details>
              {% endfor %}
            {% else %}
              <p class="muted">Bu ana kategoriye ait alt kategori tanımlanmamış.</p>

              <div class="grid" style="margin-top: 8px;">
                {% for p in main.products.all %}
                  {% if p.is_active %}
                    <div class="card"
     data-product-id="{{ p.id }}"
     data-product-name="{{ p.name }}"
     data-product-code="{{ p.code }}">
  <div class="imgbox">
    {% if p.image %}
      <img src="{{ p.image.url }}" alt="{{ p.name }}" loading="lazy">
    {% else %}
      <div class="muted">Görsel yok</div>
    {% endif %}
  </div>

  <div class="name">{{ p.name }}</div>

  <div class="muted">
    {% if p.code %}Kod: {{ p.code }}<br>{% endif %}
  </div>

  <div class="card-footer-line">
    <div class="card-price">
      {% if p.price %}
        {% if p.discount_price or p.discount_percent %}
          <div class="discount-badge">
            İndirim -{% if p.discount_percent %}{{ p.discount_percent }}%{% else %}özel fiyat{% endif %}
          </div>
          <div class="price-row">
            <span class="price-new">
              {{ p.final_price }} ₺{% if p.unit %} / {{ p.unit }}{% endif %}
            </span>
            <span class="price-old">{{ p.price }} ₺</span>
          </div>
        {% else %}
          <div class="price-row">
            <span class="price-normal">
              {{ p.price }} ₺{% if p.unit %} / {{ p.unit }}{% endif %}
            </span>
          </div>
        {% endif %}
      {% endif %}
    </div>

    <div class="card-qty">
      <div class="qty-control" data-product-id="{{ p.id }}">
        <button type="button" class="qty-btn" data-qty-btn="minus">−</button>
        <input type="number"
               class="qty-input"
               name="qty_{{ p.id }}"
               min="0"
               value="0">
        <button type="button" class="qty-btn" data-qty-btn="plus">+</button>
      </div>
    </div>
  </div>
</div>

                  {% endif %}
                {% empty %}
                  <p class="muted">Bu kategoride henüz ürün yok.</p>
                {% endfor %}
              </div>
            {% endif %}
          </section>
        {% endfor %}
      {% else %}
        <p class="muted">
          Henüz kategori bulunmamaktadır. Lütfen yönetim panelinden kategori ve ürün ekleyiniz.
        </p>
      {% endif %}
    </section>

    {# ----- Static submit button at bottom (for desktop) ----- #}
    <div class="form-actions">
      <button type="submit" class="primary-btn">
        Siparişi Gönder
      </button>
    </div>
  </form>

  {# ----- Sticky submit button (always visible) ----- #}
  <div class="sticky-submit-bar">
    <div class="sticky-submit-inner">
      <button type="button" class="primary-btn" id="sticky-submit-btn">
        Siparişi Gönder
      </button>
    </div>
  </div>
</div>
{% endblock %}
