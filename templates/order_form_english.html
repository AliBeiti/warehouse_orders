{% extends "base.html" %}
{% block title %}Order Form{% endblock %}

{% block extra_head %}


<style>
  .tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .tab-button {
    padding: 8px 14px;
    border: 1px solid #ccc;
    background: #f7f7f7;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.95rem;
  }
  .tab-button.active {
    background: #333;
    color: #fff;
    border-color: #333;
  }
  .tab-panel {
    display: none;
  }
  .tab-panel.active {
    display: block;
  }
  
  .discount-badge {
    display: inline-block;
    padding: 2px 6px;
    font-size: 0.75rem;
    background: #ff9800;
    color: #fff;
    border-radius: 4px;
    margin-bottom: 4px;
  }

  .price-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: baseline;
    margin-top: 4px;
  }

  .price-old {
    text-decoration: line-through;
    color: #777;
    font-size: 0.9rem;
  }

  .price-new {
    font-weight: 700;
    font-size: 1rem;
  }

  .price-normal {
    font-weight: 600;
  }

  .qty-control {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-top: 4px;
  }

  .qty-input {
    width: 60px;
    text-align: center;
    padding: 4px;
  }

  .qty-btn {
    border: 1px solid #ccc;
    background: #f7f7f7;
    border-radius: 4px;
    width: 28px;
    height: 28px;
    line-height: 1;
    font-size: 18px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    user-select: none;
  }

  .qty-btn:hover {
    background: #e0e0e0;
  }

  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  /* Firefox */
  input[type="number"] {
    -moz-appearance: textfield;
  }
    /* Page layout */
  .page-wrapper {
    max-width: 1200px;
    margin: 0 auto;
  }

  .section-card {
    background: #fafafa;
    border: 1px solid #e3e3e3;
    border-radius: 10px;
    padding: 16px 20px;
    margin-bottom: 24px;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .section-title {
    margin: 0;
    font-size: 1.2rem;
  }

  .section-subtitle {
    margin: 0;
    font-size: 0.9rem;
    color: #777;
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 16px;
  }

  .primary-btn {
    padding: 10px 24px;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    background: #333;
    color: #fff;
    cursor: pointer;
  }

  .primary-btn:hover {
    background: #111;
  }

</style>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const tabButtons = document.querySelectorAll("[data-tab-target]");
  const tabPanels = document.querySelectorAll("[data-tab-panel]");

  function activateTab(targetId) {
    tabButtons.forEach(btn => {
      btn.classList.toggle("active", btn.dataset.tabTarget === targetId);
    });
    tabPanels.forEach(panel => {
      panel.classList.toggle("active", panel.dataset.tabPanel === targetId);
    });
  }

  if (tabButtons.length > 0) {
    // Default: activate first tab
    activateTab(tabButtons[0].dataset.tabTarget);
  }

  tabButtons.forEach(btn => {
    btn.addEventListener("click", function () {
      activateTab(this.dataset.tabTarget);
    });
  });

  // Quantity +/- buttons
  document.querySelectorAll(".qty-btn").forEach(function (btn) {
    btn.addEventListener("click", function () {
      const direction = this.dataset.qtyBtn; // "plus" or "minus"
      const wrapper = this.closest(".qty-control");
      if (!wrapper) return;

      const input = wrapper.querySelector(".qty-input");
      if (!input) return;

      const min = parseInt(input.getAttribute("min") || "0", 10);
      let value = parseInt(input.value || "0", 10);
      if (Number.isNaN(value)) value = 0;

      if (direction === "plus") value += 1;
      else if (direction === "minus") value -= 1;

      if (value < min) value = min;
      input.value = value;
    });
  });
  // Auto-select quantity text when focusing the input
  document.querySelectorAll(".qty-input").forEach(function (input) {
    input.addEventListener("focus", function () {
      this.select();
    });
    input.addEventListener("click", function () {
      this.select();
    });
  });
});

</script>
{% endblock %}

{% block content %}
<div class="page-wrapper">

  {% if error_list %}
    <div class="section-card" style="border-color:#f0a6a6; background:#fff5f5;">
      <ul style="color: #c0392b; margin:0; padding-left:18px;">
        {% for e in error_list %}
          <li>{{ e }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="POST">
    {% csrf_token %}

    {# ---- Customer info card ---- #}
    <section class="section-card">
      <div class="section-header">
        <h2 class="section-title">Customer information</h2>
        <p class="section-subtitle">Please fill in your contact details.</p>
      </div>

      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px;">
        <div>
          <label>Name (required):</label><br>
          <input type="text" name="customer_name" required
                 value="{{ customer_name|default_if_none:'' }}"
                 style="width: 100%; max-width: 300px;">
        </div>

        <div>
          <label>Phone:</label><br>
          <input type="text" name="customer_phone" required
                 value="{{ customer_phone|default_if_none:'' }}"
                 style="width: 100%; max-width: 300px;">
        </div>

        <div>
          <label>Email:</label><br>
          <input type="email" name="customer_email" required
                 value="{{ customer_email|default_if_none:'' }}"
                 style="width: 100%; max-width: 300px;">
        </div>
      </div>

      <div style="margin-top: 12px;">
        <label>Notes:</label><br>
        <textarea name="customer_note" rows="3"
                  style="width: 100%; max-width: 600px;">{{ customer_note|default_if_none:'' }}</textarea>
      </div>
    </section>

    {# ---- Products card ---- #}
    <section class="section-card">
      <div class="section-header">
        <h2 class="section-title">Products</h2>
        <p class="section-subtitle">Choose the items you want to order.</p>
      </div>

      {# Tabs for main categories #}
      {% if main_categories %}
        <div class="tabs">
          {% for main in main_categories %}
            <button type="button"
                    class="tab-button"
                    data-tab-target="cat-{{ main.id }}">
              {{ main.name }}
            </button>
          {% endfor %}
        </div>

        {# Panels for each main category #}
        {% for main in main_categories %}
          <section class="tab-panel" data-tab-panel="cat-{{ main.id }}">
            {% if main.subcategories.all %}
              {% for sub in main.subcategories.all %}
                <details open style="margin-bottom: 16px;">
                  <summary style="font-weight: 600; cursor: pointer; font-size: 1.05rem;">
                    {{ sub.name }}
                  </summary>

                  <div class="grid" style="margin-top: 8px;">
                    {% for p in sub.products.all %}
                      {% if p.is_active %}
                        <div class="card">
                          <div class="imgbox">
                            {% if p.image %}
                              <img src="{{ p.image.url }}" alt="{{ p.name }}">
                            {% else %}
                              <div class="muted">No image</div>
                            {% endif %}
                          </div>

                          <div class="name">{{ p.name }}</div>
                          <div class="muted">
                            {% if p.code %}Code: {{ p.code }}<br>{% endif %}
                            {% if p.price %}
                              {% if p.discount_price or p.discount_percent %}
                                <div class="discount-badge">
                                  İndirim -{% if p.discount_percent %}{{ p.discount_percent }}%{% else %}özel fiyat{% endif %}
                                </div>
                                <div class="price-row">
                                  <span class="price-new">
                                    {{ p.final_price }} ₺{% if p.unit %} / {{ p.unit }}{% endif %}
                                  </span>
                                  <span class="price-old">{{ p.price }} ₺</span>
                                </div>
                              {% else %}
                                <div class="price-row">
                                  <span class="price-normal">
                                    {{ p.price }} ₺{% if p.unit %} / {{ p.unit }}{% endif %}
                                  </span>
                                </div>
                              {% endif %}
                            {% endif %}
                          </div>

                          <div style="margin-top: 8px;">
                            <label>Quantity:</label>
                            <div class="qty-control" data-product-id="{{ p.id }}">
                              <button type="button" class="qty-btn" data-qty-btn="minus">−</button>
                              <input type="number"
                                     class="qty-input"
                                     name="qty_{{ p.id }}"
                                     min="0"
                                     value="0">
                              <button type="button" class="qty-btn" data-qty-btn="plus">+</button>
                            </div>
                          </div>
                        </div>
                      {% endif %}
                    {% empty %}
                      <p class="muted">No products in this category yet.</p>
                    {% endfor %}
                  </div>
                </details>
              {% endfor %}
            {% else %}
              <p class="muted">No subcategories defined for this category yet.</p>
              <div class="grid" style="margin-top: 8px;">
                {% for p in main.products.all %}
                  {% if p.is_active %}
                    <div class="card">
                      <div class="imgbox">
                        {% if p.image %}
                          <img src="{{ p.image.url }}" alt="{{ p.name }}">
                        {% else %}
                          <div class="muted">No image</div>
                        {% endif %}
                      </div>

                      <div class="name">{{ p.name }}</div>
                      <div class="muted">
                        {% if p.code %}Code: {{ p.code }}<br>{% endif %}
                        {% if p.price %}
                          {% if p.discount_price or p.discount_percent %}
                            <div class="discount-badge">
                              İndirim -{% if p.discount_percent %}{{ p.discount_percent }}%{% else %}özel fiyat{% endif %}
                            </div>
                            <div class="price-row">
                              <span class="price-new">
                                {{ p.final_price }} ₺{% if p.unit %} / {{ p.unit }}{% endif %}
                              </span>
                              <span class="price-old">{{ p.price }} ₺</span>
                            </div>
                          {% else %}
                            <div class="price-row">
                              <span class="price-normal">
                                {{ p.price }} ₺{% if p.unit %} / {{ p.unit }}{% endif %}
                              </span>
                            </div>
                          {% endif %}
                        {% endif %}
                      </div>

                      <div style="margin-top: 8px;">
                        <label>Quantity:</label>
                        <div class="qty-control" data-product-id="{{ p.id }}">
                          <button type="button" class="qty-btn" data-qty-btn="minus">−</button>
                          <input type="number"
                                 class="qty-input"
                                 name="qty_{{ p.id }}"
                                 min="0"
                                 value="0">
                          <button type="button" class="qty-btn" data-qty-btn="plus">+</button>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% empty %}
                  <p class="muted">No products in this category yet.</p>
                {% endfor %}
              </div>
            {% endif %}
          </section>
        {% endfor %}
      {% else %}
        <p class="muted">No categories available. Please create categories and products in admin.</p>
      {% endif %}
    </section>

    <div class="form-actions">
      <button type="submit" class="primary-btn">
        Submit Order
      </button>
    </div>
  </form>
</div>
{% endblock %}
